<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="common.codrim.dao.TbDailyReportMapper" >
  <resultMap id="BaseResultMap" type="common.codrim.pojo.TbDailyReport" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="job_category" property="jobCategory" jdbcType="INTEGER" />
    <result column="customer_id" property="customerId" jdbcType="BIGINT" />
    <result column="follow_user" property="followUser" jdbcType="BIGINT" />
    <result column="follow_type" property="followType" jdbcType="INTEGER" />
    <result column="follow_detail" property="followDetail" jdbcType="VARCHAR" />
    <result column="follow_problem" property="followProblem" jdbcType="VARCHAR" />
    <result column="support" property="support" jdbcType="VARCHAR" />
    <result column="suggestion" property="suggestion" jdbcType="VARCHAR" />
    <result column="create_date" property="createDate" jdbcType="DATE" />
    <result column="contact_name" property="contactName" jdbcType="VARCHAR" />
    <result column="contact_position" property="contactPosition" jdbcType="VARCHAR" />
    <result column="contact_phone" property="contactPhone" jdbcType="VARCHAR" />
    <result column="contact_email" property="contactEmail" jdbcType="VARCHAR" />
    <result column="contact_wx" property="contactWx" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="DailyReportResultMap" type="common.codrim.query.resultmap.DailyReport" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="job_category" property="jobCategory" jdbcType="INTEGER" />
    <result column="customer_id" property="customerId" jdbcType="BIGINT" />
    <result column="follow_user" property="followUser" jdbcType="BIGINT" />
    <result column="follow_type" property="followType" jdbcType="INTEGER" />
    <result column="follow_detail" property="followDetail" jdbcType="VARCHAR" />
    <result column="follow_problem" property="followProblem" jdbcType="VARCHAR" />
    <result column="support" property="support" jdbcType="VARCHAR" />
    <result column="suggestion" property="suggestion" jdbcType="VARCHAR" />
    <result column="create_date" property="createDate" jdbcType="DATE" />
    <result column="contact_name" property="contactName" jdbcType="VARCHAR" />
    <result column="contact_position" property="contactPosition" jdbcType="VARCHAR" />
    <result column="contact_phone" property="contactPhone" jdbcType="VARCHAR" />
    <result column="contact_email" property="contactEmail" jdbcType="VARCHAR" />
    <result column="contact_wx" property="contactWx" jdbcType="VARCHAR" />
    <result column="followUsername" property="followUsername" jdbcType="VARCHAR" />
    <result column="customerName" property="customerName" jdbcType="VARCHAR" />
    <result column="channelName" property="channelName" jdbcType="VARCHAR" />
    <result column="reportCount" property="reportCount" jdbcType="INTEGER" />
    <result column="reportTotal" property="reportTotal" jdbcType="INTEGER" />
    <result column="latestReplyBy" property="latestReplyBy" jdbcType="VARCHAR" />
    <result column="latestReplyDate" property="latestReplyDate" jdbcType="TIMESTAMP" />
  </resultMap>
  <sql id="Base_Column_List" >
    id, job_category, customer_id, follow_user, follow_type, follow_detail, follow_problem, 
    support, suggestion, create_date, contact_name, contact_position, contact_phone, 
    contact_email, contact_wx
  </sql>
  
  	<select id="getById" resultMap="DailyReportResultMap" >
		select dr.id, job_category, customer_id, follow_user, follow_type, follow_detail, follow_problem, 
    		support, suggestion, dr.create_date, dr.contact_name, dr.contact_position, dr.contact_phone, dr.contact_email, dr.contact_wx,
			c.customer_name as customerName, a.account as followUsername, cn.channel_name as channelName
		from tb_daily_report dr
		left join tb_customer c on c.id=dr.customer_id
		left join tb_channel cn on cn.id=dr.customer_id
		join tb_admin a on a.id=dr.follow_user
		where dr.id=#{id}
	</select>
  	<select id="count" resultType="java.lang.Integer" >
		select count(1) 
		from tb_daily_report dr
		<where>
			<if test="param.jobCategory != null">
				dr.job_category = #{param.jobCategory}
			</if>
			<if test="param.followUser != null">
				and dr.follow_user = #{param.followUser}
			</if>
			<if test="param.followType != null">
				and dr.follow_type = #{param.followType}
			</if>
			<if test="param.createDateFrom != null">
				and dr.create_date &gt;= #{param.createDateFrom }
			</if>
			<if test="param.createDateTo != null">
				and dr.create_date &lt;= #{param.createDateTo}
			</if>
		</where>
	</select>
	<select id="page" resultMap="DailyReportResultMap" >
		select dr.id, job_category, dr.customer_id, follow_user, follow_type, follow_detail, follow_problem, 
    		support, suggestion, dr.create_date, 
			c.customer_name as customerName, a.account as followUsername, cn.channel_name as channelName,
			ndr.account as latestReplyBy,ndr.reply_date as latestReplyDate
		from tb_daily_report dr
		left join tb_customer c on c.id=dr.customer_id
		left join tb_channel cn on cn.id=dr.customer_id
		left join (
			select r.report_id,a.account,r.reply_date
			from tb_daily_report_reply r
			join (
				select max(id) as nid
				from tb_daily_report_reply
				group by report_id
			) mr on mr.nid=r.id
			join tb_admin a on a.id=r.reply_by
		) ndr on ndr.report_id=dr.id
		join tb_admin a on a.id=dr.follow_user
		<where>
			<if test="param.jobCategory != null">
				dr.job_category = #{param.jobCategory}
			</if>
			<if test="param.followUser != null">
				and dr.follow_user = #{param.followUser}
			</if>
			<if test="param.followType != null">
				and dr.follow_type = #{param.followType}
			</if>
			<if test="param.createDateFrom != null">
				and dr.create_date &gt;= #{param.createDateFrom }
			</if>
			<if test="param.createDateTo != null">
				and dr.create_date &lt;= #{param.createDateTo}
			</if>
		</where>
		order by id desc
		limit #{startPage},#{size}
	</select>
	<select id="getDailyReportSummary" resultMap="DailyReportResultMap" >
		select dr.follow_user, dr.create_date, count(1) as reportCount, a.account as followUsername
		from tb_daily_report dr
		join tb_admin a on a.id=dr.follow_user
		<where>
			<if test="param.jobCategory != null">
				dr.job_category = #{param.jobCategory}
			</if>
			<if test="param.followUser != null">
				and dr.follow_user = #{param.followUser}
			</if>
			<if test="param.followType != null">
				and dr.follow_type = #{param.followType}
			</if>
			<if test="param.createDateFrom != null">
				and dr.create_date &gt;= #{param.createDateFrom }
			</if>
			<if test="param.createDateTo != null">
				and dr.create_date &lt;= #{param.createDateTo}
			</if>
		</where>
		group by dr.follow_user,dr.create_date
	</select>
  
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    select 
    <include refid="Base_Column_List" />
    from tb_daily_report
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    delete from tb_daily_report
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="common.codrim.pojo.TbDailyReport" useGeneratedKeys="true" keyProperty="id" >
    insert into tb_daily_report (job_category, customer_id, follow_user, 
      follow_type, follow_detail, follow_problem, 
      support, suggestion, create_date, 
      contact_name, contact_position, contact_phone, 
      contact_email, contact_wx)
    values (#{jobCategory,jdbcType=INTEGER}, #{customerId,jdbcType=BIGINT}, #{followUser,jdbcType=BIGINT}, 
      #{followType,jdbcType=INTEGER}, #{followDetail,jdbcType=VARCHAR}, #{followProblem,jdbcType=VARCHAR}, 
      #{support,jdbcType=VARCHAR}, #{suggestion,jdbcType=VARCHAR}, #{createDate,jdbcType=DATE}, 
      #{contactName,jdbcType=VARCHAR}, #{contactPosition,jdbcType=VARCHAR}, #{contactPhone,jdbcType=VARCHAR}, 
      #{contactEmail,jdbcType=VARCHAR}, #{contactWx,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="common.codrim.pojo.TbDailyReport" useGeneratedKeys="true" keyProperty="id" >
    insert into tb_daily_report
    <trim prefix="(" suffix=")" suffixOverrides="," >
      job_category,
      customer_id,
      follow_user,
      follow_type,
      follow_detail,
      follow_problem,
      support,
      suggestion,
      create_date,
      contact_name,
      contact_position,
      contact_phone,
      contact_email,
      contact_wx,
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      #{jobCategory,jdbcType=INTEGER},
      #{customerId,jdbcType=BIGINT},
      #{followUser,jdbcType=BIGINT},
      #{followType,jdbcType=INTEGER},
      #{followDetail,jdbcType=VARCHAR},
      #{followProblem,jdbcType=VARCHAR},
      #{support,jdbcType=VARCHAR},
      #{suggestion,jdbcType=VARCHAR},
      #{createDate,jdbcType=DATE},
      #{contactName,jdbcType=VARCHAR},
      #{contactPosition,jdbcType=VARCHAR},
      #{contactPhone,jdbcType=VARCHAR},
      #{contactEmail,jdbcType=VARCHAR},
      #{contactWx,jdbcType=VARCHAR},
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="common.codrim.pojo.TbDailyReport" >
    update tb_daily_report
    <set >
      <if test="jobCategory != null" >
        job_category = #{jobCategory,jdbcType=INTEGER},
      </if>
      <if test="customerId != null" >
        customer_id = #{customerId,jdbcType=BIGINT},
      </if>
      <if test="followUser != null" >
        follow_user = #{followUser,jdbcType=BIGINT},
      </if>
      <if test="followType != null" >
        follow_type = #{followType,jdbcType=INTEGER},
      </if>
      <if test="followDetail != null" >
        follow_detail = #{followDetail,jdbcType=VARCHAR},
      </if>
      <if test="followProblem != null" >
        follow_problem = #{followProblem,jdbcType=VARCHAR},
      </if>
      <if test="support != null" >
        support = #{support,jdbcType=VARCHAR},
      </if>
      <if test="suggestion != null" >
        suggestion = #{suggestion,jdbcType=VARCHAR},
      </if>
      <if test="createDate != null" >
        create_date = #{createDate,jdbcType=DATE},
      </if>
      <if test="contactName != null" >
        contact_name = #{contactName,jdbcType=VARCHAR},
      </if>
      <if test="contactPosition != null" >
        contact_position = #{contactPosition,jdbcType=VARCHAR},
      </if>
      <if test="contactPhone != null" >
        contact_phone = #{contactPhone,jdbcType=VARCHAR},
      </if>
      <if test="contactEmail != null" >
        contact_email = #{contactEmail,jdbcType=VARCHAR},
      </if>
      <if test="contactWx != null" >
        contact_wx = #{contactWx,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="common.codrim.pojo.TbDailyReport" >
    update tb_daily_report
    set job_category = #{jobCategory,jdbcType=INTEGER},
      customer_id = #{customerId,jdbcType=BIGINT},
      follow_user = #{followUser,jdbcType=BIGINT},
      follow_type = #{followType,jdbcType=INTEGER},
      follow_detail = #{followDetail,jdbcType=VARCHAR},
      follow_problem = #{followProblem,jdbcType=VARCHAR},
      support = #{support,jdbcType=VARCHAR},
      suggestion = #{suggestion,jdbcType=VARCHAR},
      create_date = #{createDate,jdbcType=DATE},
      contact_name = #{contactName,jdbcType=VARCHAR},
      contact_position = #{contactPosition,jdbcType=VARCHAR},
      contact_phone = #{contactPhone,jdbcType=VARCHAR},
      contact_email = #{contactEmail,jdbcType=VARCHAR},
      contact_wx = #{contactWx,jdbcType=VARCHAR}
    where id = #{id,jdbcType=BIGINT}
  </update>
</mapper>