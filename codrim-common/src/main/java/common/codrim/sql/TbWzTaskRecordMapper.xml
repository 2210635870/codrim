<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="common.codrim.dao.TbWzTaskRecordMapper" >
  <resultMap id="BaseResultMap" type="common.codrim.pojo.TbWzTaskRecord" >
    <id column="record_id" property="recordId" jdbcType="BIGINT" />
    <result column="user_id" property="userId" jdbcType="BIGINT" />
    <result column="task_id" property="taskId" jdbcType="BIGINT" />
    <result column="step_id" property="stepId" jdbcType="BIGINT" />
    <result column="step_type" property="stepType" jdbcType="INTEGER" />
    <result column="income_gold" property="incomeGold" jdbcType="BIGINT" />
    <result column="income_money" property="incomeMoney" jdbcType="DOUBLE" />
    <result column="leader_income" property="leaderIncome" jdbcType="BIGINT" />
    <result column="finish_date" property="finishDate" jdbcType="DATE" />
    <result column="app_screen1" property="appScreen1" jdbcType="VARCHAR" />
    <result column="app_screen2" property="appScreen2" jdbcType="VARCHAR" />
    <result column="app_screen3" property="appScreen3" jdbcType="VARCHAR" />
    <result column="app_screen4" property="appScreen4" jdbcType="VARCHAR" />
    <result column="app_screen5" property="appScreen5" jdbcType="VARCHAR" />
    <result column="review_status" property="reviewStatus" jdbcType="INTEGER" />
    <result column="review_remark" property="reviewRemark" jdbcType="VARCHAR" />
    <result column="review_by" property="reviewBy" jdbcType="BIGINT" />
    <result column="review_date" property="reviewDate" jdbcType="DATE" />
  </resultMap>
   <resultMap id="TaskRecordInfoResultMap" type="common.codrim.wz.sql.result.TaskRecordInfo" >
    <id column="record_id" property="recordId" jdbcType="BIGINT" />
    <result column="user_id" property="userId" jdbcType="BIGINT" />
    <result column="task_id" property="taskId" jdbcType="BIGINT" />
    <result column="step_id" property="stepId" jdbcType="BIGINT" />
    <result column="income_money" property="incomeMoney" jdbcType="DOUBLE" />
    <result column="income_gold" property="incomeGold" jdbcType="BIGINT" />
    <result column="leader_income" property="leaderIncome" jdbcType="BIGINT" />
    <result column="finish_date" property="finishDate" jdbcType="DATE" />
    <result column="app_screen1" property="appScreen1" jdbcType="VARCHAR" />
    <result column="app_screen2" property="appScreen2" jdbcType="VARCHAR" />
    <result column="app_screen3" property="appScreen3" jdbcType="VARCHAR" />
    <result column="app_screen4" property="appScreen4" jdbcType="VARCHAR" />
    <result column="app_screen5" property="appScreen5" jdbcType="VARCHAR" />
    <result column="review_status" property="reviewStatus" jdbcType="INTEGER" />
    <result column="review_remark" property="reviewRemark" jdbcType="VARCHAR" />
    <result column="review_by" property="reviewBy" jdbcType="BIGINT" />
    <result column="review_date" property="reviewDate" jdbcType="DATE" />
    <result column="task_name" property="taskName" jdbcType="VARCHAR" />
    <result column="step_desc" property="stepDesc" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="TaskRecord4ReviewResultMap" type="common.codrim.wz.sql.result.TaskReviewInfo" >
    <id column="record_id" property="recordId" jdbcType="BIGINT" />
    <result column="user_id" property="userId" jdbcType="BIGINT" />
    <result column="task_id" property="taskId" jdbcType="BIGINT" />
    <result column="step_id" property="stepId" jdbcType="BIGINT" />
    <result column="step_type" property="stepType" jdbcType="INTEGER" />
    <result column="income_money" property="incomeMoney" jdbcType="DOUBLE" />
    <result column="income_gold" property="incomeGold" jdbcType="BIGINT" />
    <result column="leader_income" property="leaderIncome" jdbcType="BIGINT" />
    <result column="finish_date" property="finishDate" jdbcType="DATE" />
    <result column="app_screen1" property="appScreen1" jdbcType="VARCHAR" />
    <result column="app_screen2" property="appScreen2" jdbcType="VARCHAR" />
    <result column="app_screen3" property="appScreen3" jdbcType="VARCHAR" />
    <result column="app_screen4" property="appScreen4" jdbcType="VARCHAR" />
    <result column="app_screen5" property="appScreen5" jdbcType="VARCHAR" />
    <result column="review_status" property="reviewStatus" jdbcType="INTEGER" />
    <result column="review_remark" property="reviewRemark" jdbcType="VARCHAR" />
    <result column="review_by" property="reviewBy" jdbcType="BIGINT" />
    <result column="review_date" property="reviewDate" jdbcType="DATE" />
    <result column="username" property="username" jdbcType="VARCHAR" />
    <result column="phoneNumber" property="phoneNumber" jdbcType="VARCHAR" />
    <result column="taskName" property="taskName" jdbcType="VARCHAR" />
    <result column="appIcon" property="appIcon" jdbcType="VARCHAR" />
    <result column="taskOrigPrice" property="taskOrigPrice" jdbcType="DOUBLE" />
    <result column="stepDesc" property="stepDesc" jdbcType="VARCHAR" />
    <result column="screenDesc" property="screenDesc" jdbcType="VARCHAR" />
    <result column="rewardPercent" property="rewardPercent" jdbcType="INTEGER" />
  </resultMap>
  <resultMap id="TaskReportInfoResultMap" type="common.codrim.wz.sql.result.TaskReportInfo" >
  	<result column="taskId" property="taskId" jdbcType="BIGINT" />
  	<result column="taskName" property="taskName" jdbcType="VARCHAR" />
  	<result column="taskOrigPrice" property="taskOrigPrice" jdbcType="DOUBLE" />
    <result column="effect" property="effect" jdbcType="INTEGER" />
    <result column="cost" property="cost" jdbcType="DOUBLE" />
    <result column="finishDate" property="finishDate" jdbcType="DATE" />
  </resultMap>
  <resultMap id="StepReportInfoResultMap" type="common.codrim.wz.sql.result.StepReportInfo" >
  	<result column="taskOrigPrice" property="taskOrigPrice" jdbcType="DOUBLE" />
  	<result column="stepId" property="stepId" jdbcType="BIGINT" />
  	<result column="stepEffect" property="stepEffect" jdbcType="INTEGER" />
  	<result column="stepDesc" property="stepDesc" jdbcType="VARCHAR" />
  	<result column="stepCost" property="stepCost" jdbcType="DOUBLE" />
  	<result column="rewardPercent" property="rewardPercent" jdbcType="INTEGER" />
  </resultMap>
  <sql id="Base_Column_List" >
    record_id, user_id, task_id, step_id, step_type, income_gold, income_money, leader_income, 
    finish_date, app_screen1, app_screen2, app_screen3, app_screen4, app_screen5, review_status, 
    review_remark, review_by, review_date
  </sql>
  
  <select id="getNowDayTaskNums"  resultType="java.lang.Integer" >
		select count(1)
		from tb_wz_task_record
		where user_id=#{userId} and finish_date=#{date}
	</select>
  	<select id="getTodayPoints"  resultType="java.lang.Long" >
		select COALESCE(sum(income_gold),0)
		from tb_wz_task_record
		where user_id=#{userId} and finish_date=#{date}
	</select>
  	<select id="getRecordByStepAndUser" resultMap="BaseResultMap" >
		select <include refid="Base_Column_List" />
		from tb_wz_task_record
		where user_id=#{userId} and step_id=#{stepId}
	</select>
  	<select id="getLastFinishedRecord" resultMap="BaseResultMap" >
		select <include refid="Base_Column_List" />
		from tb_wz_task_record
		where user_id=#{userId} and task_id=#{taskId}
		order by record_id desc limit 1
	</select>
	<select id="count" resultType="java.lang.Integer" >
		select count(1) 
		from tb_wz_task_record
		<where>
			<if test="param.userId != null">
				user_id = #{param.userId}
			</if>
			<if test="param.realFinished">
				and ((step_type in (1,2)) or (step_type=3 and review_status=2))
			</if>
		</where>
	</select>
	<select id="page" resultMap="TaskRecordInfoResultMap" >
		select record_id, user_id, tr.task_id, tr.step_id, tr.step_type, income_gold, finish_date, tr.app_screen1, 
		    tr.app_screen2, tr.app_screen3, tr.app_screen4, tr.app_screen5, review_status, review_remark, review_by, review_date,
		    t.task_name, ts.step_desc
		from tb_wz_task_record tr
		left join tb_wz_task t on t.task_id=tr.task_id
		left join tb_wz_task_step ts on ts.step_id=tr.step_id
		<where>
			<if test="param.userId != null">
				tr.user_id = #{param.userId}
			</if>
			<if test="param.realFinished">
				and ((tr.step_type in (1,2)) or (tr.step_type=3 and tr.review_status=2))
			</if>
		</where>
		order by record_id desc
		limit #{startPage},#{size}
	</select>
	<select id="page4Review" resultMap="TaskRecord4ReviewResultMap" >
		select record_id, tr.user_id, tr.task_id, tr.step_id, tr.step_type, tr.income_gold, tr.finish_date, tr.app_screen1, 
		    tr.app_screen2, tr.app_screen3, tr.app_screen4, tr.app_screen5, tr.review_status, tr.review_remark, tr.review_by, tr.review_date,
    		u.username as username, u.phone_number as phoneNumber, t.task_name as taskName, t.app_icon as appIcon, t.task_orig_price as taskOrigPrice,
    		ts.step_desc as stepDesc, ts.screen_desc as screenDesc, ts.reward_percent as rewardPercent
		from tb_wz_task_record tr
		left join tb_wz_user u on u.user_id=tr.user_id
		left join tb_wz_task t on t.task_id=tr.task_id
		left join tb_wz_task_step ts on ts.step_id=tr.step_id
		<where>
			<if test="param.stepType != null">
				tr.step_type = #{param.stepType}
			</if>
			<if test="param.taskId != null">
				and t.task_id = #{param.taskId}
			</if>
			<if test="param.username != null">
				and u.username = #{param.username}
			</if>
			<if test="param.phoneNumber != null">
				and u.phone_number = #{param.phoneNumber}
			</if>
			<if test="param.reviewStatus != null">
				and tr.review_status = #{param.reviewStatus}
			</if>
		</where>
		order by tr.record_id desc
		limit #{startPage},#{size}
	</select>
	<select id="count4Review" resultType="java.lang.Integer" >
		select count(1) 
		from tb_wz_task_record tr
		left join tb_wz_user u on u.user_id=tr.user_id
		left join tb_wz_task t on t.task_id=tr.task_id
		left join tb_wz_task_step ts on ts.step_id=tr.step_id
		<where>
			<if test="param.stepType != null">
				tr.step_type = #{param.stepType}
			</if>
			<if test="param.taskId != null">
				and t.task_id = #{param.taskId}
			</if>
			<if test="param.username != null">
				and u.username = #{param.username}
			</if>
			<if test="param.phoneNumber != null">
				and u.phone_number = #{param.phoneNumber}
			</if>
			<if test="param.reviewStatus != null">
				and tr.review_status = #{param.reviewStatus}
			</if>
		</where>
	</select>
	<select id="getRecord4Review" resultMap="TaskRecord4ReviewResultMap" >
		select record_id, tr.user_id, tr.task_id, tr.step_id, tr.step_type, tr.income_gold, tr.finish_date, tr.app_screen1, 
		    tr.app_screen2, tr.app_screen3, tr.app_screen4, tr.app_screen5, tr.review_status, tr.review_remark, tr.review_by, tr.review_date,
    		u.username as username, u.phone_number as phoneNumber, t.task_name as taskName, t.app_icon as appIcon, t.task_orig_price as taskOrigPrice,
    		ts.step_desc as stepDesc, ts.screen_desc as screenDesc, ts.reward_percent as rewardPercent, tr.leader_income
		from tb_wz_task_record tr
		left join tb_wz_user u on u.user_id=tr.user_id
		left join tb_wz_task t on t.task_id=tr.task_id
		left join tb_wz_task_step ts on ts.step_id=tr.step_id
		where tr.record_id=#{recordId}
	</select>
	<insert id="batchTransferRecord" >
	    update tb_wz_task_record set user_id=#{toUser} where user_id=#{fromUser}
	</insert>
	
	<!-- For Generate Report Start limit #{startPage},#{size} -->
	<select id="pageTaskReportInfo" resultMap="TaskReportInfoResultMap" >
		SELECT tr.task_id as taskId, tr.finish_date as finishDate, t.task_name as taskName, SUM(ts.is_final) AS effect, 
			t.task_orig_price as taskOrigPrice, SUM(tr.income_money * 1000000)/1000000 AS cost
		FROM tb_wz_task_record tr
		JOIN tb_wz_task t ON t.task_id=tr.task_id
		JOIN tb_wz_task_step ts ON tr.step_id=ts.step_id
		WHERE 1=1 AND ((tr.step_type IN (1,2)) OR (tr.step_type=3 AND tr.review_status=2))
		<if test="param.finishDateFrom != null">
			and tr.finish_date &gt;= #{param.finishDateFrom}
		</if>
		<if test="param.finishDateTo != null">
			and tr.finish_date &lt;= #{param.finishDateTo}
		</if>
		<if test="param.taskId != null">
			and tr.task_id=#{param.taskId}
		</if>
		GROUP BY tr.task_id,tr.finish_date
		order by tr.finish_date
		
	</select>
	<select id="countTaskReportInfo" resultType="java.lang.Integer" >
		SELECT count(distinct tr.task_id, tr.finish_date)
		FROM tb_wz_task_record tr
		JOIN tb_wz_task t ON t.task_id=tr.task_id
		JOIN tb_wz_task_step ts ON tr.step_id=ts.step_id
		WHERE 1=1 AND ((tr.step_type IN (1,2)) OR (tr.step_type=3 AND tr.review_status=2))
		<if test="param.finishDateFrom != null">
			and tr.finish_date &gt;= #{param.finishDateFrom}
		</if>
		<if test="param.finishDateTo != null">
			and tr.finish_date &lt;= #{param.finishDateTo}
		</if>
		<if test="param.taskId != null">
			and tr.task_id=#{param.taskId}
		</if>
	</select>
	<select id="getStepReportInfoListByTask" resultMap="StepReportInfoResultMap" >
		SELECT ts.step_id as stepId, count(tr.record_id) AS stepEffect, ts.step_desc as stepDesc,
			ts.reward_percent as rewardPercent, SUM(tr.income_money * 1000000)/1000000 AS stepCost,
			t.task_orig_price as taskOrigPrice
		FROM tb_wz_task_step ts
		LEFT JOIN tb_wz_task t on t.task_id=ts.task_id
		LEFT JOIN tb_wz_task_record tr ON tr.step_id=ts.step_id
		AND tr.finish_date=#{param.finishDateFrom}
		AND ((tr.step_type IN (1,2)) OR (tr.step_type=3 AND tr.review_status=2))
		<where>
			<if test="param.taskId != null">
				ts.task_id=#{param.taskId}
			</if>
		</where>
		GROUP BY ts.step_id
	</select>
	<!-- For Generate Report End -->
  
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    select 
    <include refid="Base_Column_List" />
    from tb_wz_task_record
    where record_id = #{recordId,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    delete from tb_wz_task_record
    where record_id = #{recordId,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="common.codrim.pojo.TbWzTaskRecord" useGeneratedKeys="true" keyProperty="recordId" >
    insert into tb_wz_task_record (user_id, task_id, step_id, 
      step_type, income_gold, income_money, 
      leader_income, finish_date, app_screen1, 
      app_screen2, app_screen3, app_screen4, 
      app_screen5, review_status, review_remark, 
      review_by, review_date)
    values (#{userId,jdbcType=BIGINT}, #{taskId,jdbcType=BIGINT}, #{stepId,jdbcType=BIGINT}, 
      #{stepType,jdbcType=INTEGER}, #{incomeGold,jdbcType=BIGINT}, #{incomeMoney,jdbcType=DOUBLE}, 
      #{leaderIncome,jdbcType=BIGINT}, #{finishDate,jdbcType=DATE}, #{appScreen1,jdbcType=VARCHAR}, 
      #{appScreen2,jdbcType=VARCHAR}, #{appScreen3,jdbcType=VARCHAR}, #{appScreen4,jdbcType=VARCHAR}, 
      #{appScreen5,jdbcType=VARCHAR}, #{reviewStatus,jdbcType=INTEGER}, #{reviewRemark,jdbcType=VARCHAR}, 
      #{reviewBy,jdbcType=BIGINT}, #{reviewDate,jdbcType=DATE})
  </insert>
  <insert id="insertSelective" parameterType="common.codrim.pojo.TbWzTaskRecord" useGeneratedKeys="true" keyProperty="recordId" >
    insert into tb_wz_task_record
    <trim prefix="(" suffix=")" suffixOverrides="," >
      user_id,
      task_id,
      step_id,
      step_type,
      income_gold,
      income_money,
      leader_income,
      finish_date,
      app_screen1,
      app_screen2,
      app_screen3,
      app_screen4,
      app_screen5,
      review_status,
      review_remark,
      review_by,
      review_date,
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      #{userId,jdbcType=BIGINT},
      #{taskId,jdbcType=BIGINT},
      #{stepId,jdbcType=BIGINT},
      #{stepType,jdbcType=INTEGER},
      #{incomeGold,jdbcType=BIGINT},
      #{incomeMoney,jdbcType=DOUBLE},
      #{leaderIncome,jdbcType=BIGINT},
      #{finishDate,jdbcType=DATE},
      #{appScreen1,jdbcType=VARCHAR},
      #{appScreen2,jdbcType=VARCHAR},
      #{appScreen3,jdbcType=VARCHAR},
      #{appScreen4,jdbcType=VARCHAR},
      #{appScreen5,jdbcType=VARCHAR},
      #{reviewStatus,jdbcType=INTEGER},
      #{reviewRemark,jdbcType=VARCHAR},
      #{reviewBy,jdbcType=BIGINT},
      #{reviewDate,jdbcType=DATE},
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="common.codrim.pojo.TbWzTaskRecord" >
    update tb_wz_task_record
    <set >
      <if test="userId != null" >
        user_id = #{userId,jdbcType=BIGINT},
      </if>
      <if test="taskId != null" >
        task_id = #{taskId,jdbcType=BIGINT},
      </if>
      <if test="stepId != null" >
        step_id = #{stepId,jdbcType=BIGINT},
      </if>
      <if test="stepType != null" >
        step_type = #{stepType,jdbcType=INTEGER},
      </if>
      <if test="incomeGold != null" >
        income_gold = #{incomeGold,jdbcType=BIGINT},
      </if>
      <if test="incomeMoney != null" >
        income_money = #{incomeMoney,jdbcType=DOUBLE},
      </if>
      <if test="leaderIncome != null" >
        leader_income = #{leaderIncome,jdbcType=BIGINT},
      </if>
      <if test="finishDate != null" >
        finish_date = #{finishDate,jdbcType=DATE},
      </if>
      <if test="appScreen1 != null" >
        app_screen1 = #{appScreen1,jdbcType=VARCHAR},
      </if>
      <if test="appScreen2 != null" >
        app_screen2 = #{appScreen2,jdbcType=VARCHAR},
      </if>
      <if test="appScreen3 != null" >
        app_screen3 = #{appScreen3,jdbcType=VARCHAR},
      </if>
      <if test="appScreen4 != null" >
        app_screen4 = #{appScreen4,jdbcType=VARCHAR},
      </if>
      <if test="appScreen5 != null" >
        app_screen5 = #{appScreen5,jdbcType=VARCHAR},
      </if>
      <if test="reviewStatus != null" >
        review_status = #{reviewStatus,jdbcType=INTEGER},
      </if>
      <if test="reviewRemark != null" >
        review_remark = #{reviewRemark,jdbcType=VARCHAR},
      </if>
      <if test="reviewBy != null" >
        review_by = #{reviewBy,jdbcType=BIGINT},
      </if>
      <if test="reviewDate != null" >
        review_date = #{reviewDate,jdbcType=DATE},
      </if>
    </set>
    where record_id = #{recordId,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="common.codrim.pojo.TbWzTaskRecord" >
    update tb_wz_task_record
    set user_id = #{userId,jdbcType=BIGINT},
      task_id = #{taskId,jdbcType=BIGINT},
      step_id = #{stepId,jdbcType=BIGINT},
      step_type = #{stepType,jdbcType=INTEGER},
      income_gold = #{incomeGold,jdbcType=BIGINT},
      income_money = #{incomeMoney,jdbcType=DOUBLE},
      leader_income = #{leaderIncome,jdbcType=BIGINT},
      finish_date = #{finishDate,jdbcType=DATE},
      app_screen1 = #{appScreen1,jdbcType=VARCHAR},
      app_screen2 = #{appScreen2,jdbcType=VARCHAR},
      app_screen3 = #{appScreen3,jdbcType=VARCHAR},
      app_screen4 = #{appScreen4,jdbcType=VARCHAR},
      app_screen5 = #{appScreen5,jdbcType=VARCHAR},
      review_status = #{reviewStatus,jdbcType=INTEGER},
      review_remark = #{reviewRemark,jdbcType=VARCHAR},
      review_by = #{reviewBy,jdbcType=BIGINT},
      review_date = #{reviewDate,jdbcType=DATE}
    where record_id = #{recordId,jdbcType=BIGINT}
  </update>
</mapper>